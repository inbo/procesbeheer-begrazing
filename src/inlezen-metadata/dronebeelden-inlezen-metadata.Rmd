---
title: "Metadata dronebeelden"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = TRUE)

library(terra)
library(rprojroot)
library(tidyverse)
library(fs)
source(find_root_file("src/utils/utils.R", criterion = is_git_root))
```



# Inlezen 

## Digitaal oppervlakte model (dronebeelden) (Digital Surface Model DSM)


Dronebeelden rechtstreeks vanaf gedeelde google drive via lokale sync in G:\


Voordelen:

- script blijft werken omdat iedereen naar dezelfde locatie verwijst (op voorwaarde dat G gekozen werd als schijf voor google drive lokaal te syncen)
- download vanaf google drive gebeurd automatisch, geen authentificatie nodig (google drive for desktop zal enkel die bestanden lokaal beschikbaar maken die effectief gebruikt worden)


```{r inlezen, warning=FALSE}
map_procesbeheer <- get_map_procesbeheer()
fs::dir_exists(map_procesbeheer)
all_tif_files <- fs::dir_ls(file.path(map_procesbeheer, "Drone_geg"), 
                            recurse = TRUE, 
                            glob = "*.tif")
load_tif <- function(path) {
  tifname <- basename(path)
  tifname <- fs::path_ext_remove(tifname)
  tifname <- make.names(tifname)
  assign(tifname, terra::rast(path), inherits = TRUE)
}
walk(all_tif_files, load_tif)
```

```{r check-metadata}
X20200831_0179202_Ename1_DEM

cat(crs(X20200831_0179202_Ename1_DEM))
```


```{r}
plot(X20200831_0179202_Ename1_DEM)
```




## Digitaal terrein model (DTM)

Digitaal Hoogtemodel Vlaanderen II:

- https://download.vlaanderen.be/Producten/Detail?id=939&title=Digitaal_Hoogtemodel_Vlaanderen_II_DTM_raster_1_m#
- https://www.geopunt.be/catalogus/datasetfolder/f52b1a13-86bc-4b64-8256-88cc0d1a8735
    - Enkel downloadservice en WMS (= enkel visualisatie, geen data). 
    - Mogelijke optie: kaartblad selecteren, zip downloaden en unzippen, raster inlezen
- Gemakkelijkste toegang via S-schijf INBO.



```{r}
map_inbo_gis <- get_map_inbogis()
dtm_path <- file.path(
  map_inbo_gis, "Vlaanderen", "Hoogte", "DHMVII", 
  "DHMVIIDTMRAS1m.tif")
dtm1m <- terra::rast(dtm_path)

dtm1m

#all.equal(crs(dtm1m), crs(X20200831_0179202_Ename1_DEM))

```



## Canopy height model (CHM)

Canopy height model = digitaal oppervlaktemodel - digitaal hoogtemodel

*R*


```{r}
calc_chm <- function(dsm, dtm, overwrite = FALSE) {
  
  
  # prelim check
  destination <- file.path(map_procesbeheer, "chm")
  
  if (!dir.exists(destination)) {
    dir.create(destination, recursive = TRUE)
  }
  
  tifname <- paste0(gsub("DEM", "CHM", dsm@ptr$names), ".tif")
  
  if (file.exists(file.path(destination, tifname)) && !overwrite) {
    stop(paste0("CHM for ", dsm, " already exists"))
  }
  
  # crop dtm to drone image extent
  floor_extent_dsm <- floor(ext(dsm))
  ext(dsm) <- floor_extent_dsm
  dtm_crop <- crop(dtm, dsm)
  
  # disaggregate dtm to 0.025 x 0.025 resolution
  dtm_crop <- disaggregate(dtm_crop, fact = 1/0.025)
  
  # resample dsm so it has same raster as dtm_crop
  dsm <- terra::resample(dsm, dtm_crop)
  
  # wkt string overschrijven (zelfde crs, maar verschillende representatie)
  crs(dsm) <- crs(dtm_crop)
  
  # calculate CHM
  chm <- dsm - dtm_crop
  
  # Write the rasterfile
  
  terra::writeRaster(x = chm, 
              filename = file.path(destination, tifname), 
              gdal = c("COMPRESS=LZW", "TFW=YES"), 
              overwrite = overwrite)

}
```


```{r}
calc_chm(dsm = X20200831_0179202_Ename1_DEM, dtm = dtm1m) #enkele minuten
```

```{r}
#check resultaat
load_tif(path = file.path(map_procesbeheer, "chm", "20200831_0179202_Ename1_CHM.tif"))

X20200831_0179202_Ename1_CHM

plot(X20200831_0179202_Ename1_CHM)
```


## NDVI 




## GRTS master sample

Zie https://inbo.github.io/n2khab/articles/v030_GRTSmh.html


## Indelen in hoogteklassen en oppervlakte-aandelen bepalen 

Mbv exactextractr.

# Resources

https://datacarpentry.org/r-raster-vector-geospatial/03-raster-reproject-in-r/

https://semba-blog.netlify.app/12/14/2020/manipulate-and-visualize-raster-data-with-leaflet-and-tmap-in-r/
